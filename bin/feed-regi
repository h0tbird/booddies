#!/bin/bash

#----------------------------------------------------------------------------
# Globals:
#----------------------------------------------------------------------------

registry='regi01.demo.lan:5000'
images='jplock/zookeeper:3.4.6
mesosphere/mesos-master:0.20.1
mesosphere/mesos-slave:0.20.1
mesosphere/marathon:v0.7.5'

E_BAD_PULL=1
E_BAD_TAG=1
E_BAD_PUSH=1

#----------------------------------------------------------------------------
# Source miscellaneous bash functions:
#----------------------------------------------------------------------------

source ./bin/misclib.sh

#---------------------------------------------------------------------------
# Search, pull, tag and push:
#---------------------------------------------------------------------------

for img in ${images}; do

  #---------
  # Search:
  #---------

  msg="Searching '${img}' in private registry..."
  misc::stat_busy "${msg}"
  name=${img#*/}; name=${name%:*}

  if curl -sX GET \
  http://${registry}/v1/repositories/library/${name}/tags/${img#*:} | \
  grep -qv error; then
    misc::stat_done
    continue
  else
    misc::stat_done
  fi

  #-------
  # Pull:
  #-------

  msg="Pulling '${img}' image..."
  misc::stat_busy "${msg}"

  if ! docker pull ${img} >> /tmp/booddies.log; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_PULL}"
  else
    misc::stat_done
  fi

  #------
  # Tag:
  #------

  msg="Tagging '${img}' image..."
  misc::stat_busy "${msg}"

  if ! docker tag ${img} ${registry}/${img#*/} >> /tmp/booddies.log; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_TAG}"
  else
    misc::stat_done
  fi

  #-------
  # Push:
  #-------

  msg="Pushing '${registry}/${img#*/}' image..."
  misc::stat_busy "${msg}"

  if ! docker push ${registry}/${img#*/} >> /tmp/booddies.log; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_PUSH}"
  else
    misc::stat_done
  fi

done
