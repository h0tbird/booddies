#!/bin/bash

#----------------------------------------------------------------------------
# Globals:
#----------------------------------------------------------------------------

# Settings:
readonly REGISTRY='regi01:5000'
readonly LOG_FILE='/tmp/booddies.log'
readonly IMAGES='
h0tbird/zookeeper:latest
mesosphere/mesos-master:0.22.1-1.0.ubuntu1404
mesosphere/mesos-slave:0.22.1-1.0.ubuntu1404
mesosphere/marathon:v0.8.2'

# Return codes:
readonly E_BAD_CMD=10
readonly E_BAD_PULL=11
readonly E_BAD_TAG=12
readonly E_BAD_PUSH=13
readonly E_BAD_PURGE=14

# Commands:
readonly CMD_CURL=$(type -P curl); [ -z "${CMD_CURL}" ] && exit ${E_BAD_CMD}
readonly CMD_DOCKER=$(type -P docker); [ -z "${CMD_DOCKER}" ] && exit ${E_BAD_CMD}

#----------------------------------------------------------------------------
# Source miscellaneous bash functions:
#----------------------------------------------------------------------------

[ -f booddies.sh ] && source booddies.sh
[ -f ./bin/booddies.sh ] && source ./bin/booddies.sh
[ -f /etc/booddies/booddies.sh ] && source /etc/booddies/booddies.sh

#---------------------------------------------------------------------------
# Seek, pull, tag, push and purge:
#---------------------------------------------------------------------------

for img in ${IMAGES}; do

  #-------
  # Seek:
  #-------

  name=${img#*/}; name=${name%:*}
  msg="Seeking '${name}/${img#*:}' private image..."
  misc::stat_busy "${msg}"

  if ${CMD_CURL} -sX GET \
  http://${REGISTRY}/v1/repositories/library/${name}/tags/${img#*:} | \
  grep -qv 'error'; then
    misc::stat_done
    continue
  else
    misc::stat_done
  fi

  #-------
  # Pull:
  #-------

  msg="Pulling '${img}' image..."
  misc::stat_busy "${msg}"

  if ! ${CMD_DOCKER} pull ${img} >> ${LOG_FILE}; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_PULL}"
  else
    misc::stat_done
  fi

  #------
  # Tag:
  #------

  msg="Tagging '${img}' image..."
  misc::stat_busy "${msg}"

  if ! ${CMD_DOCKER} tag -f ${img} ${REGISTRY}/${img#*/} >> ${LOG_FILE}; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_TAG}"
  else
    misc::stat_done
  fi

  #-------
  # Push:
  #-------

  msg="Pushing '${REGISTRY}/${img#*/}' image..."
  misc::stat_busy "${msg}"

  if ! ${CMD_DOCKER} push ${REGISTRY}/${img#*/} >> ${LOG_FILE}; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_PUSH}"
  else
    misc::stat_done
  fi

  #--------
  # Purge:
  #--------

  msg="Purging '${name}/${img#*:}' local image..."
  misc::stat_busy "${msg}"

  if ! ${CMD_DOCKER} rmi ${img} ${REGISTRY}/${img#*/} >> ${LOG_FILE}; then
    misc::log "[ERROR] ${msg}"
    misc::stat_fail
    exit "${E_BAD_PURGE}"
  else
    misc::stat_done
  fi

done
